<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan + Panoramor</title>

  <style>
    :root {
      --bg:#111;
      --panel:#0f0f0f;
      --panel2:#1a1a1a;
      --line:rgba(255,255,255,0.10);
      --txt:rgba(255,255,255,0.92);
      --txt2:rgba(255,255,255,0.65);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
    }

    h2{
      margin: 0 0 12px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* ================= PLAN ================= */
    .plan{
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000 url("plan.png") center / contain no-repeat;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    /* ================= HOTSPOTS ================= */
    .hotspot{
      position:absolute;
      width:26px;
      height:26px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.35);
      transform: translate(-50%, -50%);
      cursor:pointer;
      z-index: 2;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .hotspot::after{
      content:"";
      position:absolute;
      inset:7px;
      border-radius:999px;
      background: rgba(255,255,255,0.92);
      transition: inset .12s ease, opacity .12s ease;
    }

    .hotspot:hover{
      transform: translate(-50%, -50%) scale(1.08);
      background: rgba(255,255,255,0.08);
    }

    .hotspot.active{
      box-shadow: 0 0 0 10px rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
    }
    .hotspot.active::after{
      inset: 6px;
    }

    .hotspot.peek{
      box-shadow: 0 0 0 10px rgba(255,255,255,0.10);
      animation: pulse 1.15s infinite;
    }
    @keyframes pulse{
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.22); }
      70%  { box-shadow: 0 0 0 14px rgba(255,255,255,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.00); }
    }

    /* ================= HOVER CARD (dot tooltip) ================= */
    .tip{
      position:absolute;
      width: 240px;
      background: rgba(15,15,15,0.96);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      display:none;
      pointer-events:none;
      z-index: 5;

      left: 50%;
      top: -12px;
      transform: translate(-50%, -100%);
    }

    .tip img{
      width:100%;
      height: 120px;
      object-fit: cover;
      display:block;
    }

    .tip .meta{
      padding: 10px 12px 12px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
    }

    .tip .title{
      font-size: 14px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tip .hint{
      font-size: 12px;
      color: var(--txt2);
    }

    .tip::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-8px;
      transform: translateX(-50%);
      width:14px;
      height:14px;
      background: rgba(15,15,15,0.96);
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      rotate: 45deg;
    }

    .tip.flipY{
      top: calc(100% + 12px);
      transform: translate(-50%, 0);
    }
    .tip.flipY::after{
      top:-8px;
      bottom:auto;
      border-right:none;
      border-bottom:none;
      border-left: 1px solid var(--line);
      border-top: 1px solid var(--line);
      rotate: 45deg;
    }

    .tip.clampLeft{ left:0; transform: translate(0, -100%); }
    .tip.clampRight{ left:auto; right:0; transform: translate(0, -100%); }
    .tip.clampLeft.flipY, .tip.clampRight.flipY{ transform: translate(0,0); }

    /* ================= VIEWER OVER PLAN (overlay in plan) ================= */
    .viewerWrap{
      position:absolute;
      inset:0;
      display:none;
      z-index: 9;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(2px);
    }
    .viewerWrap.open{ display:block; }

    .viewer{
      width:100%;
      height:100%;
      border-radius: 14px;
      overflow:hidden;
      background:#000;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 16px 50px rgba(0,0,0,0.45);
      position:relative;
    }

    .viewerHeader{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:12px;
      z-index:2;
      pointer-events:none;
    }

    .viewerTitle{
      pointer-events:none;
      font-size:14px;
      color: rgba(255,255,255,0.88);
      background: rgba(0,0,0,0.42);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 8px 10px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      max-width: 60%;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .viewerBtns{
      display:flex;
      gap:8px;
      pointer-events:auto;
    }

    .btn{
      border:0;
      background: rgba(0,0,0,0.48);
      border: 1px solid rgba(255,255,255,0.14);
      color:#fff;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:14px;
      backdrop-filter: blur(6px);
      user-select:none;
    }
    .btn:hover{ background: rgba(0,0,0,0.62); }

    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#000;
    }

    /* ================= CAROUSEL ================= */
    .railWrap{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.28);
    }
    .railWrap.hidden{ display:none; }

    .railHeader{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .railHeader .sub{
      font-size: 13px;
      color: var(--txt2);
    }
    .railControls{ display:flex; gap:8px; }

    .rail{
      display:flex;
      gap:12px;
      overflow-x:auto;
      scroll-behavior:smooth;
      padding-bottom: 6px;

      /* “Apple-igt” snap */
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;

      /* göm scrollbar */
      scrollbar-width: none;      /* Firefox */
      -ms-overflow-style: none;   /* old Edge */
    }
    .rail::-webkit-scrollbar{ display:none; } /* Chrome/Edge/Safari */

    .navBtn{
      border:0;
      background: rgba(255,255,255,0.12);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
      user-select:none;
    }
    .navBtn:hover{ background: rgba(255,255,255,0.18); }
    .navBtn:disabled{ opacity:0.35; cursor:not-allowed; }

    .card{
      flex: 0 0 260px; /* lite större så “active” inte hamnar utanför */
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      position:relative;
      scroll-snap-align: start;
    }
    .card:hover{ transform: translateY(-2px); }

    .card img{
      width:100%;
      height: 145px;
      object-fit: cover;
      display:block;
    }

    .badge360{
      position:absolute;
      top:10px;
      left:10px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      backdrop-filter: blur(6px);
    }

    .card .cmeta{
      padding: 12px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
    }
    .card .cname{
      font-size: 14px;
      font-weight: 700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .card .ctag{
      font-size: 12px;
      color: var(--txt2);
      white-space: nowrap;
    }

    /* tydligare active */
    .card.active{
      border-color: rgba(255,255,255,0.85);
      box-shadow:
        0 0 0 4px rgba(255,255,255,0.25),
        0 18px 50px rgba(0,0,0,0.50);
      transform: translateY(-3px);
    }
    .card.active .ctag{ color: rgba(255,255,255,0.92); }

    /* lite luft så active inte “klipper” längst ner */
    .railWrap{ padding-bottom: 16px; }

    /* mobil: lite tightare UI */
    @media (max-width: 640px){
      .viewerWrap.open{
        position: fixed;
        inset: 0;
        padding: 0;
        background: #000;
        backdrop-filter: none;
      }
      .viewer{
        border-radius: 0;
        border: 0;
        box-shadow: none;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>Plan</h2>

    <div class="plan" id="plan">
      <!-- Viewer overlay INSIDE plan -->
      <div class="viewerWrap" id="viewerWrap">
        <div class="viewer" id="viewer">
          <div class="viewerHeader">
            <div class="viewerTitle" id="roomLabel"></div>
            <div class="viewerBtns">
              <button class="btn" id="fsBtn">⤢ Fullskärm</button>
              <button class="btn" id="closeBtn">✕ Stäng</button>
            </div>
          </div>
          <iframe id="viewerFrame" loading="lazy"></iframe>
        </div>
      </div>
    </div>

    <!-- HERO RAIL -->
    <div class="railWrap" id="railWrap">
      <div class="railHeader">
        <div>
          <div style="font-weight:750">Rum</div>
          <div class="sub">Klick för 360°. Hover visar var på planen.</div>
        </div>
        <div class="railControls">
          <button class="navBtn" id="prevBtn">◀</button>
          <button class="navBtn" id="nextBtn">▶</button>
        </div>
      </div>
      <div class="rail" id="rail"></div>
    </div>
  </div>

  <script>
    // ======= Mobil-detektering (styr rail-visibility vid öppet pano) =======
    const IS_MOBILE = window.matchMedia("(max-width: 640px)").matches;

    // ======= Rum-konfig (pano = query param i 360viewer.html) =======
    const rooms = [
      { name:"Entré",      pano:"entre",     hero:"HERO/hero_entre.png",     top:"48%",  left:"45%"  },
      { name:"Kök",        pano:"kok",       hero:"HERO/hero_kok.png",       top:"54%",  left:"71%"  },
      { name:"Kontor 1",   pano:"kontor1",   hero:"HERO/hero_kontor1.png",   top:"70%",  left:"82%"  },
      { name:"Kontor 2",   pano:"kontor2",   hero:"HERO/hero_kontor2.png",   top:"75%",  left:"63%"  },
      { name:"Mötesrum 1", pano:"motesrum1", hero:"HERO/hero_motesrum1.png", top:"78%",  left:"37.5%"},
      { name:"Mötesrum 2", pano:"motesrum2", hero:"HERO/hero_motesrum2.png", top:"19%",  left:"46.5%"},
      { name:"Teamsrum",   pano:"teamsrum1", hero:"HERO/hero_teamsrum1.png", top:"80%",  left:"48%"  }
    ];

    const plan      = document.getElementById("plan");
    const rail      = document.getElementById("rail");
    const railWrap  = document.getElementById("railWrap");

    const viewerWrap= document.getElementById("viewerWrap");
    const viewer    = document.getElementById("viewer");
    const frame     = document.getElementById("viewerFrame");
    const roomLabel = document.getElementById("roomLabel");

    const closeBtn  = document.getElementById("closeBtn");
    const fsBtn     = document.getElementById("fsBtn");
    const prevBtn   = document.getElementById("prevBtn");
    const nextBtn   = document.getElementById("nextBtn");

    const dotByPano  = new Map();
    const cardByPano = new Map();

    let activePano = null;

    function setActive(pano){
      activePano = pano;
      dotByPano.forEach((dot, key) => dot.classList.toggle("active", key === pano));
      cardByPano.forEach((card, key) => card.classList.toggle("active", key === pano));
    }

    function setPeek(pano){
      dotByPano.forEach((dot, key) => dot.classList.toggle("peek", key === pano));
      cardByPano.forEach((card, key) => card.classList.toggle("active", key === pano));
    }

    function clearPeek(){
      dotByPano.forEach(dot => dot.classList.remove("peek"));
      setActive(activePano);
    }

    function openRoom(room){
      viewerWrap.classList.add("open");
      roomLabel.textContent = room.name;
      frame.src = `360viewer.html?pano=${room.pano}`;
      setActive(room.pano);
      if (IS_MOBILE && viewer.requestFullscreen) {
        viewer.requestFullscreen().catch(()=>{});
      }

      // Mobil: dölj rail när pano öppnas
      if (IS_MOBILE && railWrap) railWrap.classList.add("hidden");

      const card = cardByPano.get(room.pano);
      if (card) {
        const left = card.offsetLeft - (rail.clientWidth - card.clientWidth) / 2;
        rail.scrollTo({ left, behavior: "smooth" });
      }
    }

    function closeRoom(){
      viewerWrap.classList.remove("open");
      frame.src = "";
      roomLabel.textContent = "";
      setActive(null);

      // Mobil: visa rail igen när pano stängs
      if (railWrap) railWrap.classList.remove("hidden");
    }

    async function toggleFullscreen(){
      try{
        if (!document.fullscreenElement){
          await viewer.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      }catch(e){
        console.log("Fullscreen error:", e);
      }
    }

    function updateFsBtn(){
      fsBtn.textContent = document.fullscreenElement ? "⤡ Avsluta" : "⤢ Fullskärm";
    }

    function updateArrowState(){
      const maxScrollLeft = rail.scrollWidth - rail.clientWidth;
      prevBtn.disabled = rail.scrollLeft <= 2;
      nextBtn.disabled = rail.scrollLeft >= maxScrollLeft - 2 || maxScrollLeft <= 0;
    }

    function scrollByCards(direction){
      const firstCard = rail.querySelector(".card");
      const step = firstCard ? (firstCard.getBoundingClientRect().width + 12) * 2 : 520;
      rail.scrollBy({ left: direction * step, behavior:"smooth" });
    }

    // Tooltip clamp + flip
    function positionTip(dot, tip){
      tip.classList.remove("flipY","clampLeft","clampRight");
      tip.style.display = "block";
      tip.style.visibility = "hidden";

      const planRect = plan.getBoundingClientRect();
      const dotRect  = dot.getBoundingClientRect();
      const tipRect  = tip.getBoundingClientRect();
      const pad = 10;

      const tipLeft  = dotRect.left - tipRect.width / 2;
      const tipRight = dotRect.left + tipRect.width / 2;

      if (tipLeft < planRect.left + pad) tip.classList.add("clampLeft");
      if (tipRight > planRect.right - pad) tip.classList.add("clampRight");

      const spaceAbove = dotRect.top - planRect.top;
      const needed = tipRect.height + 18;
      if (spaceAbove < needed) tip.classList.add("flipY");

      tip.style.visibility = "visible";
    }

    // Build dots + tips + cards
    rooms.forEach(room => {
      // dot
      const dot = document.createElement("button");
      dot.className = "hotspot";
      dot.style.top = room.top;
      dot.style.left = room.left;
      dot.dataset.pano = room.pano;
      dot.title = room.name;

      // tip
      const tip = document.createElement("div");
      tip.className = "tip";
      tip.innerHTML = `
        <img loading="lazy" src="${room.hero}" alt="${room.name}">
        <div class="meta">
          <div class="title">${room.name}</div>
          <div class="hint">Klicka</div>
        </div>
      `;
      dot.appendChild(tip);

      dot.addEventListener("pointerenter", (e) => {
        if (e.pointerType !== "mouse") return; // ingen hover på touch
        positionTip(dot, tip);
        setPeek(room.pano);
      });
      dot.addEventListener("pointerleave", (e) => {
        if (e.pointerType !== "mouse") return;
        tip.style.display = "none";
        clearPeek();
      });
      dot.addEventListener("click", () => openRoom(room));

      plan.appendChild(dot);
      dotByPano.set(room.pano, dot);

      // card
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.pano = room.pano;
      card.innerHTML = `
        <div class="badge360">360°</div>
        <img loading="lazy" src="${room.hero}" alt="${room.name}">
        <div class="cmeta">
          <div class="cname">${room.name}</div>
          <div class="ctag">Öppna</div>
        </div>
      `;

      card.addEventListener("pointerenter", (e) => {
          if (e.pointerType !== "mouse") return;
          setPeek(room.pano);
        });
        card.addEventListener("pointerleave", (e) => {
          if (e.pointerType !== "mouse") return;
          clearPeek();
        });
      card.addEventListener("click", () => openRoom(room));

      rail.appendChild(card);
      cardByPano.set(room.pano, card);
    });

    // controls
    closeBtn.addEventListener("click", closeRoom);
    fsBtn.addEventListener("click", toggleFullscreen);
    document.addEventListener("fullscreenchange", updateFsBtn);

    prevBtn.addEventListener("click", () => scrollByCards(-1));
    nextBtn.addEventListener("click", () => scrollByCards(1));
    rail.addEventListener("scroll", () => requestAnimationFrame(updateArrowState));
    window.addEventListener("resize", updateArrowState);

    updateArrowState();
    updateFsBtn();
  </script>
</body>
</html>
